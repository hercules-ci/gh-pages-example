<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Store Path Specification - Nix 2.31.2+1 Reference Manual</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../custom.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Nix 2.31.2+1 Reference Manual</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/NixOS/nix" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/NixOS/nix/tree/master/doc/manual/source/protocols/store-path.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="complete-store-path-calculation"><a class="header" href="#complete-store-path-calculation">Complete Store Path Calculation</a></h1>
<p>This is the complete specification for how <a href="../store/store-path.html">store path</a>s are calculated.</p>
<p>The format of this specification is close to <a href="https://en.wikipedia.org/wiki/Extended_Backus%E2%80%93Naur_form">Extended Backus–Naur form</a>, but must deviate for a few things such as hash functions which we treat as bidirectional for specification purposes.</p>
<p>Regular users do <em>not</em> need to know this information --- store paths can be treated as black boxes computed from the properties of the store objects they refer to.
But for those interested in exactly how Nix works, e.g. if they are reimplementing it, this information can be useful.</p>
<h2 id="store-path-proper"><a class="header" href="#store-path-proper">Store path proper</a></h2>
<pre><code class="language-ebnf">store-path = store-dir "/" digest "-" name
</code></pre>
<p>where</p>
<ul>
<li>
<p><code>name</code> = the name of the store object.</p>
</li>
<li>
<p><code>store-dir</code> = the <a href="../store/store-path.html#store-directory">store directory</a></p>
</li>
<li>
<p><code>digest</code> = base-32 representation of the compressed to 160 bits <a href="https://en.m.wikipedia.org/wiki/SHA-256">SHA-256</a> hash of <code>fingerprint</code></p>
</li>
</ul>
<p>For the definition of the hash compression algorithm, please refer to the section 5.1 of
the <a href="https://edolstra.github.io/pubs/phd-thesis.pdf">Nix thesis</a>, which also defines the
specifics of base-32 encoding. Note that base-32 encoding processes the hash bytestring from
the end, while base-16 processes in from the beginning.</p>
<h2 id="fingerprint"><a class="header" href="#fingerprint">Fingerprint</a></h2>
<ul>
<li>
<pre><code class="language-ebnf">fingerprint = type ":sha256:" inner-digest ":" store ":" name
</code></pre>
<p>Note that it includes the location of the store as well as the name to make sure that changes to either of those are reflected in the hash
(e.g. you won't get <code>/nix/store/&lt;digest&gt;-name1</code> and <code>/nix/store/&lt;digest&gt;-name2</code>, or <code>/gnu/store/&lt;digest&gt;-name1</code>, with equal hash parts).</p>
</li>
<li>
<p><code>type</code> = one of:</p>
<ul>
<li>
<pre><code class="language-ebnf">| "text" { ":" store-path }
</code></pre>
<p>This is for the
<a href="../store/store-object/content-address.html#method-text">"Text"</a>
method of content addressing store objects.
The optional trailing store paths are the references of the store object.</p>
</li>
<li>
<pre><code class="language-ebnf">| "source" { ":" store-path } [ ":self" ]
</code></pre>
<p>This is for the
<a href="../store/store-object/content-address.html#method-nix-archive">"Nix Archive"</a>
method of content addressing store objects,
if the hash algorithm is <a href="https://en.m.wikipedia.org/wiki/SHA-256">SHA-256</a>.
Just like in the "Text" case, we can have the store objects referenced by their paths.
Additionally, we can have an optional <code>:self</code> label to denote self-reference.</p>
</li>
<li>
<pre><code class="language-ebnf">| "output:" id
</code></pre>
<p>For either the outputs built from derivations,
or content-addressed store objects that are not using one of the two above cases.
To be explicit about the latter, that is currently these methods:</p>
<ul>
<li><a href="../store/store-object/content-address.html#method-flat">"Flat"</a></li>
<li><a href="../store/store-object/content-address.html#method-git">"Git"</a></li>
<li><a href="../store/store-object/content-address.html#method-nix-archive">"Nix Archive"</a> if the hash algorithm is not <a href="https://en.m.wikipedia.org/wiki/SHA-256">SHA-256</a>.</li>
</ul>
<p><code>id</code> is the name of the output (usually, "out").
For content-addressed store objects, <code>id</code>, is always "out".</p>
</li>
</ul>
</li>
<li>
<p><code>inner-digest</code> = base-16 representation of a SHA-256 hash of <code>inner-fingerprint</code>.
The base-16 encoding uses lower-cased hex digits.</p>
</li>
</ul>
<h2 id="inner-fingerprint"><a class="header" href="#inner-fingerprint">Inner fingerprint</a></h2>
<ul>
<li>
<p><code>inner-fingerprint</code> = one of the following based on <code>type</code>:</p>
<ul>
<li>
<p>if <code>type</code> = <code>"text:" ...</code>:</p>
<p>the string written to the resulting store path.</p>
</li>
<li>
<p>if <code>type</code> = <code>"source:" ...</code>:</p>
<p>the <a href="../store/file-system-object/content-address.html#serial-nix-archive">Nix Archive (NAR)</a> serialization of the <a href="../store/file-system-object.html">file system object</a> of the store object.</p>
</li>
<li>
<p>if <code>type</code> = <code>"output:" id</code>:</p>
<ul>
<li>
<p>For input-addressed derivation outputs:</p>
<p>the <a href="../protocols/derivation-aterm.html">ATerm</a> serialization of the derivation modulo fixed output derivations.</p>
</li>
<li>
<p>For content-addressed store paths:</p>
<pre><code class="language-ebnf">"fixed:out:" rec algo ":" hash ":"
</code></pre>
<p>where</p>
<ul>
<li>
<p><code>rec</code> = one of:</p>
<ul>
<li>
<pre><code class="language-ebnf">| ""
</code></pre>
<p>(empty string) for hashes of the flat (single file) serialization</p>
</li>
<li>
<pre><code class="language-ebnf">| "r:"
</code></pre>
<p>hashes of the for <a href="../store/file-system-object/content-address.html#serial-nix-archive">Nix Archive (NAR)</a> (arbitrary file system object) serialization</p>
</li>
<li>
<pre><code class="language-ebnf">| "git:"
</code></pre>
<p>hashes of the <a href="https://git-scm.com/book/en/v2/Git-Internals-Git-Objects">Git blob/tree</a> <a href="https://en.wikipedia.org/wiki/Merkle_tree">Merkel tree</a> format</p>
</li>
</ul>
</li>
<li>
<pre><code class="language-ebnf">algo = "md5" | "sha1" | "sha256"
</code></pre>
</li>
<li>
<p><code>hash</code> = base-16 representation of the path or flat hash of the contents of the path (or expected contents of the path for fixed-output derivations).</p>
</li>
</ul>
<p>Note that <code>id</code> = <code>"out"</code>, regardless of the name part of the store path.
Also note that NAR + SHA-256 must not use this case, and instead must use the <code>type</code> = <code>"source:" ...</code> case.</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="historical-note"><a class="header" href="#historical-note">Historical Note</a></h3>
<p>The <code>type</code> = <code>"source:" ...</code> and <code>type</code> = <code>"output:out"</code> grammars technically overlap in purpose,
in that both can represent data hashed by its SHA-256 NAR serialization.</p>
<p>The original reason for this way of computing names was to prevent name collisions (for security).
For instance, the thinking was that it shouldn't be feasible to come up with a derivation whose output path collides with the path for a copied source.
The former would have an <code>inner-fingerprint</code> starting with <code>output:out:</code>, while the latter would have an <code>inner-fingerprint</code> starting with <code>source:</code>.</p>
<p>Since <code>64519cfd657d024ae6e2bb74cb21ad21b886fd2a</code> (2008), however, it was decided that separating derivation-produced vs manually-hashed content-addressed data like this was not useful.
Now, data that is content-addressed with SHA-256 + NAR-serialization always uses the <code>source:...</code> construction, regardless of how it was produced (manually or by derivation).
This allows freely switching between using <a href="../glossary.html#gloss-fixed-output-derivation">fixed-output derivations</a> for fetching, and fetching out-of-band and then manually adding.
It also removes the ambiguity from the grammar.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../protocols/tarball-fetcher.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../protocols/nix-archive.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../protocols/tarball-fetcher.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../protocols/nix-archive.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../redirects.js"></script>



    </div>
    </body>
</html>
