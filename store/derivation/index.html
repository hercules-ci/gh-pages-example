<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Store Derivation and Deriving Path - Nix 2.28.4 Reference Manual</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../custom.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Nix 2.28.4 Reference Manual</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/NixOS/nix" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/NixOS/nix/tree/master/doc/manual/source/store/derivation/index.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="store-derivation-and-deriving-path"><a class="header" href="#store-derivation-and-deriving-path">Store Derivation and Deriving Path</a></h1>
<p>Besides functioning as a <a href="../../glossary.html#gloss-content-addressed-store">content-addressed store</a>, the Nix store layer works as a <a href="../../glossary.html#gloss-build-system">build system</a>.
Other systems (like Git or IPFS) also store and transfer immutable data, but they don't concern themselves with <em>how</em> that data was created.</p>
<p>This is where Nix distinguishes itself.
<em>Derivations</em> represent individual build steps, and <em>deriving paths</em> are needed to refer to the <em>outputs</em> of those build steps before they are built.</p>
<!-- The two concepts need to be introduced together because, as described below, each depends on the other. -->
<h2 id="store-derivation"><a class="header" href="#store-derivation">Store Derivation</a></h2>
<p>A derivation is a specification for running an executable on precisely defined input to produce on more <a href="../../store/store-object.html">store objects</a>.
These store objects are known as the derivation's <em>outputs</em>.</p>
<p>Derivations are <em>built</em>, in which case the process is spawned according to the spec, and when it exits, required to leave behind files which will (after post-processing) become the outputs of the derivation.
This process is described in detail in <a href="../../store/building.html">Building</a>.</p>
<!--
Some of these things are described directly below, but we envision with more material the exposition will probably want to migrate to separate pages benough this.
See outputs spec for an example of this one that migrated to its own page.
-->
<p>A derivation consists of:</p>
<ul>
<li>
<p>A name</p>
</li>
<li>
<p>An <a href="#inputs">inputs specification</a>, a set of <a href="#deriving-path">deriving paths</a></p>
</li>
<li>
<p>An <a href="./outputs/index.html">outputs specification</a>, specifying which outputs should be produced, and various metadata about them.</p>
</li>
<li>
<p>The <a href="#system">"system" type</a> (e.g. <code>x86_64-linux</code>) where the executable is to run.</p>
</li>
<li>
<p>The <a href="#process-creation-fields">process creation fields</a>: to spawn the arbitrary process which will perform the build step.</p>
</li>
</ul>
<h3 id="derivation-path"><a class="header" href="#derivation-path">Referencing derivations</a></h3>
<p>Derivations are always referred to by the <a href="../../store/store-path.html">store path</a> of the store object they are encoded to.
See the <a href="#derivation-encoding">encoding section</a> for more details on how this encoding works, and thus what exactly what store path we would end up with for a given derivation.</p>
<p>The store path of the store object which encodes a derivation is often called a <em>derivation path</em> for brevity.</p>
<h2 id="deriving-path"><a class="header" href="#deriving-path">Deriving path</a></h2>
<p>Deriving paths are a way to refer to <a href="../../store/store-object.html">store objects</a> that may or may not yet be <a href="../../glossary.html#gloss-realise">realised</a>.
There are two forms:</p>
<ul>
<li>
<p><a href="#deriving-path-constant" id="deriving-path-constant"><em>constant</em></a>: just a <a href="../../store/store-path.html">store path</a>.
It can be made <a href="../../glossary.html#gloss-validity">valid</a> by copying it into the store: from the evaluator, command line interface or another store.</p>
</li>
<li>
<p><a href="#deriving-path-output" id="deriving-path-output"><em>output</em></a>: a pair of a <a href="../../store/store-path.html">store path</a> to a <a href="#store-derivation">store derivation</a> and an <a href="./outputs/index.html">output</a> name.</p>
</li>
</ul>
<p>In pseudo code:</p>
<pre><code class="language-typescript">type OutputName = String;

type ConstantPath = {
  path: StorePath;
};

type OutputPath = {
  drvPath: StorePath;
  output: OutputName;
};

type DerivingPath = ConstantPath | OutputPath;
</code></pre>
<p>Deriving paths are necessary because, in general and particularly for <a href="../../glossary.html#gloss-content-addressing-derivation">content-addressing derivations</a>, the <a href="../../store/store-path.html">store path</a> of an <a href="./outputs/index.html">output</a> is not known in advance.
We can use an output deriving path to refer to such an output, instead of the store path which we do not yet know.</p>
<h2 id="parts-of-a-derivation"><a class="header" href="#parts-of-a-derivation">Parts of a derivation</a></h2>
<p>A derivation is constructed from the parts documented in the following subsections.</p>
<h3 id="inputs"><a class="header" href="#inputs">Inputs</a></h3>
<p>The inputs are a set of <a href="#deriving-path">deriving paths</a>, referring to all store objects needed in order to perform this build step.</p>
<p>The <a href="#process-creation-fields">process creation fields</a> will presumably include many <a href="../../store/store-path.html">store paths</a>:</p>
<ul>
<li>The path to the executable normally starts with a store path</li>
<li>The arguments and environment variables likely contain many other store paths.</li>
</ul>
<p>But rather than somehow scanning all the other fields for inputs, Nix requires that all inputs be explicitly collected in the inputs field. It is instead the responsibility of the creator of a derivation (e.g. the evaluator) to ensure that every store object referenced in another field (e.g. referenced by store path) is included in this inputs field.</p>
<h3 id="system"><a class="header" href="#system">System</a></h3>
<p>The system type on which the <a href="#attr-builder"><code>builder</code></a> executable is meant to be run.</p>
<p>A necessary condition for Nix to schedule a given derivation on some <a href="../../glossary.html#gloss-nix-instance">Nix instance</a> is for the "system" of that derivation to match that instance's <a href="../../command-ref/conf-file.html#conf-system"><code>system</code> configuration option</a> or <a href="../../command-ref/conf-file.html#conf-extra-platforms"><code>extra-platforms</code> configuration option</a>.</p>
<p>By putting the <code>system</code> in each derivation, Nix allows <em>heterogenous</em> build plans, where not all steps can be run on the same machine or same sort of machine.
Nix can schedule builds such that it automatically builds on other platforms by <a href="../../advanced-topics/distributed-builds.html">forwarding build requests</a> to other Nix instances.</p>
<h3 id="process-creation-fields"><a class="header" href="#process-creation-fields">Process creation fields</a></h3>
<p>These are the three fields which describe how to spawn the process which (along with any of its own child processes) will perform the build.
You may note that this has everything needed for an <code>execve</code> system call.</p>
<h4 id="builder"><a class="header" href="#builder">Builder</a></h4>
<p>This is the path to an executable that will perform the build and produce the <a href="./outputs/index.html">outputs</a>.</p>
<h4 id="args"><a class="header" href="#args">Arguments</a></h4>
<p>Command-line arguments to be passed to the <a href="#builder"><code>builder</code></a> executable.</p>
<p>Note that these are the arguments after the first argument.
The first argument passed to the <code>builder</code> will be the value of <code>builder</code>, as per the usual convention on Unix.
See <a href="https://en.wikipedia.org/wiki/Argv">Wikipedia</a> for details.</p>
<h4 id="env"><a class="header" href="#env">Environment Variables</a></h4>
<p>Environment variables which will be passed to the <a href="#builder">builder</a> executable.</p>
<h3 id="placeholders"><a class="header" href="#placeholders">Placeholders</a></h3>
<p>Placeholders are opaque values used within the <a href="#process-creation-fields">process creation fields</a> to [store objects] for which we don't yet know <a href="../../store/store-path.html">store path</a>s.
They are strings in the form <code>/&lt;hash&gt;</code> that are embedded anywhere within the strings of those fields, and we are <a href="https://github.com/NixOS/nix/issues/12361">considering</a> to add store-path-like placeholders.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>Output Deriving Path exist to solve the same problem as placeholders --- that is, referring to store objects for which we don't yet know a store path.
They also have a string syntax with <code>^</code>, <a href="#deriving-path-encoding">described in the encoding section</a>.
We could use that syntax instead of <code>/&lt;hash&gt;</code> for placeholders, but its human-legibility would cause problems.</p>
</blockquote>
<p>There are two types of placeholder, corresponding to the two cases where this problem arises:</p>
<ul>
<li>
<p><a href="#output-placeholder" id="output-placeholder">Output placeholder</a>:</p>
<p>This is a placeholder for a derivation's own output.</p>
</li>
<li>
<p><a href="#input-placeholder" id="input-placeholder">Input placeholder</a>:</p>
<p>This is a placeholder to a derivation's non-constant <a href="#inputs">input</a>,
i.e. an input that is an [output derived path].</p>
</li>
</ul>
<blockquote>
<p><strong>Explanation</strong></p>
<p>In general, we need to realise <a href="../../glossary.html#gloss-realise">realise</a> a <a href="../../store/store-object.html">store object</a> in order to be sure to have a store object for it.
But for these two cases this is either impossible or impractical:</p>
<ul>
<li>
<p>In the output case this is impossible:</p>
<p>We cannot build the output until we have a correct derivation, and we cannot have a correct derivation (without using placeholders) until we have the output path.</p>
</li>
<li>
<p>In the input case this is impractical:</p>
<p>If we always build a dependency first, and then refer to its output by store path, we would lose the ability for a derivation graph to describe an entire build plan consisting of multiple build steps.</p>
</li>
</ul>
</blockquote>
<h2 id="encoding"><a class="header" href="#encoding">Encoding</a></h2>
<h3 id="derivation-encoding"><a class="header" href="#derivation-encoding">Derivation</a></h3>
<p>There are two formats, documented separately:</p>
<ul>
<li>
<p>The legacy <a href="../../protocols/derivation-aterm.html">"ATerm" format</a></p>
</li>
<li>
<p>The experimental, currently under development and changing <a href="../../protocols/json/derivation.html">JSON format</a></p>
</li>
</ul>
<p>Every derivation has a canonical choice of encoding used to serialize it to a store object.
This ensures that there is a canonical <a href="../../store/store-path.html">store path</a> used to refer to the derivation, as described in <a href="#derivation-path">Referencing derivations</a>.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>Currently, the canonical encoding for every derivation is the "ATerm" format,
but this is subject to change for types derivations which are not yet stable.</p>
</blockquote>
<p>Regardless of the format used, when serializing a derivation to a store object, that store object will be content-addressed.</p>
<p>In the common case, the inputs to store objects are either:</p>
<ul>
<li>
<p><a href="#deriving-path-constant">constant deriving paths</a> for content-addressed source objects, which are "initial inputs" rather than the outputs of some other derivation</p>
</li>
<li>
<p>the outputs of other derivations</p>
</li>
</ul>
<p>If those other derivations <em>also</em> abide by this common case (and likewise for transitive inputs), then the entire closure of the serialized derivation will be content-addressed.</p>
<h3 id="deriving-path-encoding"><a class="header" href="#deriving-path-encoding">Deriving Path</a></h3>
<ul>
<li>
<p><em>constant</em></p>
<p>Constant deriving paths are encoded simply as the underlying store path is.
Thus, we see that every encoded store path is also a valid encoded (constant) deriving path.</p>
</li>
<li>
<p><em>output</em></p>
<p>Output deriving paths are encoded by</p>
<ul>
<li>
<p>encoding of a store path referring to a derivation</p>
</li>
<li>
<p>a <code>^</code> separator (or <code>!</code> in some legacy contexts)</p>
</li>
<li>
<p>the name of an output of the previously referred derivation</p>
</li>
</ul>
<blockquote>
<p><strong>Example</strong></p>
<pre><code>/nix/store/lxrn8v5aamkikg6agxwdqd1jz7746wz4-firefox-98.0.2.drv^out
</code></pre>
<p>This parses like so:</p>
<pre><code>/nix/store/lxrn8v5aamkikg6agxwdqd1jz7746wz4-firefox-98.0.2.drv^out
|------------------------------------------------------------| |-|
store path (usual encoding)                                    output name
                                                          |--|
                                                          note the ".drv"
</code></pre>
</blockquote>
</li>
</ul>
<h2 id="extending-the-model-to-be-higher-order"><a class="header" href="#extending-the-model-to-be-higher-order">Extending the model to be higher-order</a></h2>
<p><strong>Experimental feature</strong>: <a href="../../development/experimental-features.html#xp-feature-dynamic-derivations"><code>dynamic-derivations</code></a></p>
<p>So far, we have used store paths to refer to derivations.
That works because we've implicitly assumed that all derivations are created <em>statically</em> --- created by some mechanism out of band, and then manually inserted into the store.
But what if derivations could also be created dynamically within Nix?
In other words, what if derivations could be the outputs of other derivations?</p>
<blockquote>
<p><strong>Note</strong></p>
<p>In the parlance of "Build Systems à la carte", we are generalizing the Nix store layer to be a "Monadic" instead of "Applicative" build system.</p>
</blockquote>
<p>How should we refer to such derivations?
A deriving path works, the same as how we refer to other derivation outputs.
But what about a dynamic derivations output?
(i.e. how do we refer to the output of a derivation, which is itself an output of a derivation?)
For that we need to generalize the definition of deriving path, replacing the store path used to refer to the derivation with a nested deriving path:</p>
<pre><code class="language-diff"> type OutputPath = {
-  drvPath: StorePath;
+  drvPath: DerivingPath;
   output: OutputName;
 };
</code></pre>
<p>Now, the <code>drvPath</code> field of <code>OutputPath</code> is itself a <code>DerivingPath</code> instead of a <code>StorePath</code>.</p>
<p>With that change, here is updated definition:</p>
<pre><code class="language-typescript">type OutputName = String;

type ConstantPath = {
  path: StorePath;
};

type OutputPath = {
  drvPath: DerivingPath;
  output: OutputName;
};

type DerivingPath = ConstantPath | OutputPath;
</code></pre>
<p>Under this extended model, <code>DerivingPath</code>s are thus inductively built up from a root <code>ConstantPath</code>, wrapped with zero or more outer <code>OutputPath</code>s.</p>
<h3 id="deriving-path-encoding"><a class="header" href="#deriving-path-encoding">Encoding</a></h3>
<p>The encoding is adjusted in the natural way, encoding the <code>drv</code> field recursively using the same deriving path encoding.
The result of this is that it is possible to have a chain of <code>^&lt;output-name&gt;</code> at the end of the final string, as opposed to just a single one.</p>
<blockquote>
<p><strong>Example</strong></p>
<pre><code>/nix/store/lxrn8v5aamkikg6agxwdqd1jz7746wz4-firefox-98.0.2.drv^foo.drv^bar.drv^out
|----------------------------------------------------------------------------| |-|
inner deriving path (usual encoding)                                           output name
|--------------------------------------------------------------------| |-----|
even more inner deriving path (usual encoding)                         output name
|------------------------------------------------------------| |-----|
innermost constant store path (usual encoding)                 output name
</code></pre>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../store/store-path.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../store/derivation/outputs/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../store/store-path.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../store/derivation/outputs/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../redirects.js"></script>


    </div>
    </body>
</html>
