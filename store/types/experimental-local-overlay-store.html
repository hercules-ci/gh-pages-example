<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Experimental Local Overlay Store - Nix Reference Manual</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../custom.css">


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Nix Reference Manual</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/NixOS/nix" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/NixOS/nix/tree/master/doc/manual/src/store/types/experimental-local-overlay-store.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="experimental-local-overlay-store"><a class="header" href="#experimental-local-overlay-store">Experimental Local Overlay Store</a></h1>
<blockquote>
<p><strong>Warning</strong></p>
<p>This store is part of an
<a href="../../development/experimental-features.html">experimental feature</a>.</p>
<p>To use this store, make sure the
<a href="../../development/experimental-features.html#xp-feature-local-overlay-store"><code>local-overlay-store</code> experimental feature</a>
is enabled.
For example, include the following in <a href="../../command-ref/conf-file.html"><code>nix.conf</code></a>:</p>
<pre><code>extra-experimental-features = local-overlay-store
</code></pre>
</blockquote>
<p><strong>Store URL format</strong>: <code>local-overlay</code></p>
<p>This store type is a variation of the [local store] designed to leverage Linux's <a href="https://docs.kernel.org/filesystems/overlayfs.html">Overlay Filesystem</a> (OverlayFS for short).
Just as OverlayFS combines a lower and upper filesystem by treating the upper one as a patch against the lower, the local overlay store combines a lower store with an upper almost-[local store].
("almost" because while the upper filesystems for OverlayFS is valid on its own, the upper almost-store is not a valid local store on its own because some references will dangle.)
To use this store, you will first need to configure an OverlayFS mountpoint <a href="#example-filesystem-layout">appropriately</a> as Nix will not do this for you (though it will verify the mountpoint is configured correctly).</p>
<h3 id="conceptual-parts-of-a-local-overlay-store"><a class="header" href="#conceptual-parts-of-a-local-overlay-store">Conceptual parts of a local overlay store</a></h3>
<p><em>This is a more abstract/conceptual description of the parts of a layered store, an authoritative reference.
For more "practical" instructions, see the worked-out example in the next subsection.</em></p>
<p>The parts of a local overlay store are as follows:</p>
<ul>
<li>
<p><strong>Lower store</strong>:</p>
<blockquote>
<p>Specified with the <a href="#store-experimental-local-overlay-store-lower-store"><code>lower-store</code></a> setting.</p>
</blockquote>
<p>This is any store implementation that includes a store directory as part of the native operating system filesystem.
For example, this could be a [local store], [local daemon store], or even another local overlay store.</p>
<p>The local overlay store never tries to modify the lower store in any way.
Something else could modify the lower store, but there are restrictions on this
Nix itself requires that this store only grow, and not change in other ways.
For example, new store objects can be added, but deleting or modifying store objects is not allowed in general, because that will confuse and corrupt any local overlay store using those objects.
(In addition, the underlying filesystem overlay mechanism may impose additional restrictions, see below.)</p>
<p>The lower store must not change while it is mounted as part of an overlay store.
To ensure it does not, you might want to mount the store directory read-only (which then requires the [read-only] parameter to be set to <code>true</code>).</p>
<ul>
<li>
<p><strong>Lower store directory</strong>:</p>
<blockquote>
<p>Specified with <code>lower-store.real</code> setting.</p>
</blockquote>
<p>This is the directory used/exposed by the lower store.</p>
<p>As specified above, Nix requires the local store can only grow not change in other ways.
Linux's OverlayFS in addition imposes the further requirement that this directory cannot change at all.
That means that, while any local overlay store exists that is using this store as a lower store, this directory must not change.</p>
</li>
<li>
<p><strong>Lower metadata source</strong>:</p>
<blockquote>
<p>Not directly specified.
A consequence of the <code>lower-store</code> setting, depending on the type of lower store chosen.</p>
</blockquote>
<p>This is abstract, just some way to read the metadata of lower store <a href="../../store/store-object.html">store objects</a>.
For example it could be a SQLite database (for the [local store]), or a socket connection (for the [local daemon store]).</p>
<p>This need not be writable.
As stated above a local overlay store never tries to modify its lower store.
The lower store's metadata is considered part of the lower store, just as the store's <a href="../../store/file-system-object.html">file system objects</a> that appear in the store directory are.</p>
</li>
</ul>
</li>
<li>
<p><strong>Upper almost-store</strong>:</p>
<blockquote>
<p>Not directly specified.
Instead the constituent parts are independently specified as described below.</p>
</blockquote>
<p>This is almost but not quite just a [local store].
That is because taken in isolation, not as part of a local overlay store, by itself, it would appear corrupted.
But combined with everything else as part of an overlay local store, it is valid.</p>
<ul>
<li>
<p><strong>Upper layer directory</strong>:</p>
<blockquote>
<p>Specified with <a href="#store-experimental-local-overlay-store-upper-layer"><code>upper-layer</code></a> setting.</p>
</blockquote>
<p>This contains additional <a href="../../store/store-object.html">store objects</a>
(or, strictly speaking, their <a href="../../store/file-system-object.html">file system objects</a> that the local overlay store will extend the lower store with).</p>
</li>
<li>
<p><strong>Upper store directory</strong>:</p>
<blockquote>
<p>Specified with the <a href="#store-experimental-local-overlay-store-real"><code>real</code></a> setting.
This the same as the base local store setting, and can also be indirectly specified with the <a href="#store-experimental-local-overlay-store-root"><code>root</code></a> setting.</p>
</blockquote>
<p>This contains all the store objects from each of the two directories.</p>
<p>The lower store directory and upper layer directory are combined via OverlayFS to create this directory.
Nix doesn't do this itself, because it typically wouldn't have the permissions to do so, so it is the responsibility of the user to set this up first.
Nix can, however, optionally check that the OverlayFS mount settings appear as expected, matching Nix's own settings.</p>
</li>
<li>
<p><strong>Upper SQLite database</strong>:</p>
<blockquote>
<p>Not directly specified.
The location of the database instead depends on the <a href="#store-experimental-local-overlay-store-state"><code>state</code></a> setting.
It is always <code>${state}/db</code>.</p>
</blockquote>
<p>This contains the metadata of all of the upper layer <a href="../../store/store-object.html">store objects</a> (everything beyond their file system objects), and also duplicate copies of some lower layer store object's metadta.
The duplication is so the metadata for the <a href="../../glossary.html#gloss-closure">closure</a> of upper layer <a href="../../store/store-object.html">store objects</a> can be found entirely within the upper layer.
(This allows us to use the same SQL Schema as the [local store]'s SQLite database, as foreign keys in that schema enforce closure metadata to be self-contained in this way.)</p>
</li>
</ul>
</li>
</ul>
<h3 id="example-filesystem-layout"><a class="header" href="#example-filesystem-layout">Example filesystem layout</a></h3>
<p>Here is a worked out example of usage, following the concepts in the previous section.</p>
<p>Say we have the following paths:</p>
<ul>
<li>
<p><code>/mnt/example/merged-store/nix/store</code></p>
</li>
<li>
<p><code>/mnt/example/store-a/nix/store</code></p>
</li>
<li>
<p><code>/mnt/example/store-b</code></p>
</li>
</ul>
<p>Then the following store URI can be used to access a local-overlay store at <code>/mnt/example/merged-store</code>:</p>
<pre><code>local-overlay://?root=/mnt/example/merged-store&amp;lower-store=/mnt/example/store-a&amp;upper-layer=/mnt/example/store-b
</code></pre>
<p>The lower store directory is located at <code>/mnt/example/store-a/nix/store</code>, while the upper layer is at <code>/mnt/example/store-b</code>.</p>
<p>Before accessing the overlay store you will need to ensure the OverlayFS mount is set up correctly:</p>
<pre><code class="language-shell">mount -t overlay overlay \
  -o lowerdir="/mnt/example/store-a/nix/store" \
  -o upperdir="/mnt/example/store-b" \
  -o workdir="/mnt/example/workdir" \
  "/mnt/example/merged-store/nix/store"
</code></pre>
<p>Note that OverlayFS requires <code>/mnt/example/workdir</code> to be on the same volume as the <code>upperdir</code>.</p>
<p>By default, Nix will check that the mountpoint as been set up correctly and fail with an error if it has not.
You can override this behaviour by passing <a href="#store-experimental-local-overlay-store-check-mount"><code>check-mount=false</code></a> if you need to.</p>
<h2 id="settings"><a class="header" href="#settings">Settings</a></h2>
<ul>
<li>
<p><span id="store-experimental-local-overlay-store-check-mount"><a href="#store-experimental-local-overlay-store-check-mount"><code>check-mount</code></a></span></p>
<p>Check that the overlay filesystem is correctly mounted.</p>
<p>Nix does not manage the overlayfs mount point itself, but the correct
functioning of the overlay store does depend on this mount point being set up
correctly. Rather than just assume this is the case, check that the lowerdir
and upperdir options are what we expect them to be. This check is on by
default, but can be disabled if needed.</p>
<p><strong>Default:</strong> <code>true</code></p>
</li>
<li>
<p><span id="store-experimental-local-overlay-store-log"><a href="#store-experimental-local-overlay-store-log"><code>log</code></a></span></p>
<p>directory where Nix will store log files.</p>
<p><strong>Default:</strong> <code>/nix/var/log/nix</code></p>
</li>
<li>
<p><span id="store-experimental-local-overlay-store-lower-store"><a href="#store-experimental-local-overlay-store-lower-store"><code>lower-store</code></a></span></p>
<p><a href="../../command-ref/new-cli/nix3-help-stores.html#store-url-format">Store URL</a>
for the lower store. The default is <code>auto</code> (i.e. use the Nix daemon or <code>/nix/store</code> directly).</p>
<p>Must be a store with a store dir on the file system.
Must be used as OverlayFS lower layer for this store's store dir.</p>
<p><strong>Default:</strong> <em>empty</em></p>
</li>
<li>
<p><span id="store-experimental-local-overlay-store-path-info-cache-size"><a href="#store-experimental-local-overlay-store-path-info-cache-size"><code>path-info-cache-size</code></a></span></p>
<p>Size of the in-memory store path metadata cache.</p>
<p><strong>Default:</strong> <code>65536</code></p>
</li>
<li>
<p><span id="store-experimental-local-overlay-store-priority"><a href="#store-experimental-local-overlay-store-priority"><code>priority</code></a></span></p>
<p>Priority of this store when used as a <a href="../../command-ref/conf-file.html#conf-substituters">substituter</a>.
A lower value means a higher priority.</p>
<p><strong>Default:</strong> <code>0</code></p>
</li>
<li>
<p><span id="store-experimental-local-overlay-store-read-only"><a href="#store-experimental-local-overlay-store-read-only"><code>read-only</code></a></span></p>
<p>Allow this store to be opened when its <a href="../../glossary.html#gloss-nix-database">database</a> is on a read-only filesystem.</p>
<p>Normally Nix will attempt to open the store database in read-write mode, even for querying (when write access is not needed), causing it to fail if the database is on a read-only filesystem.</p>
<p>Enable read-only mode to disable locking and open the SQLite database with the <a href="https://www.sqlite.org/c3ref/open.html"><code>immutable</code> parameter</a> set.</p>
<blockquote>
<p><strong>Warning</strong>
Do not use this unless the filesystem is read-only.</p>
<p>Using it when the filesystem is writable can cause incorrect query results or corruption errors if the database is changed by another process.
While the filesystem the database resides on might appear to be read-only, consider whether another user or system might have write access to it.</p>
</blockquote>
<p><strong>Default:</strong> <code>false</code></p>
</li>
<li>
<p><span id="store-experimental-local-overlay-store-real"><a href="#store-experimental-local-overlay-store-real"><code>real</code></a></span></p>
<p>Physical path of the Nix store.</p>
<p><strong>Default:</strong> <code>/nix/store</code></p>
</li>
<li>
<p><span id="store-experimental-local-overlay-store-remount-hook"><a href="#store-experimental-local-overlay-store-remount-hook"><code>remount-hook</code></a></span></p>
<p>Script or other executable to run when overlay filesystem needs remounting.</p>
<p>This is occasionally necessary when deleting a store path that exists in both upper and lower layers.
In such a situation, bypassing OverlayFS and deleting the path in the upper layer directly
is the only way to perform the deletion without creating a "whiteout".
However this causes the OverlayFS kernel data structures to get out-of-sync,
and can lead to 'stale file handle' errors; remounting solves the problem.</p>
<p>The store directory is passed as an argument to the invoked executable.</p>
<p><strong>Default:</strong> <em>empty</em></p>
</li>
<li>
<p><span id="store-experimental-local-overlay-store-require-sigs"><a href="#store-experimental-local-overlay-store-require-sigs"><code>require-sigs</code></a></span></p>
<p>Whether store paths copied into this store should have a trusted signature.</p>
<p><strong>Default:</strong> <code>true</code></p>
</li>
<li>
<p><span id="store-experimental-local-overlay-store-root"><a href="#store-experimental-local-overlay-store-root"><code>root</code></a></span></p>
<p>Directory prefixed to all other paths.</p>
<p><strong>Default:</strong> ``</p>
</li>
<li>
<p><span id="store-experimental-local-overlay-store-state"><a href="#store-experimental-local-overlay-store-state"><code>state</code></a></span></p>
<p>Directory where Nix will store state.</p>
<p><strong>Default:</strong> <code>/dummy</code></p>
</li>
<li>
<p><span id="store-experimental-local-overlay-store-store"><a href="#store-experimental-local-overlay-store-store"><code>store</code></a></span></p>
<p>Logical location of the Nix store, usually
<code>/nix/store</code>. Note that you can only copy store paths
between stores if they have the same <code>store</code> setting.</p>
<p><strong>Default:</strong> <code>/nix/store</code></p>
</li>
<li>
<p><span id="store-experimental-local-overlay-store-system-features"><a href="#store-experimental-local-overlay-store-system-features"><code>system-features</code></a></span></p>
<p>Optional <a href="../../command-ref/conf-file.html#conf-system-features">system features</a> available on the system this store uses to build derivations.</p>
<p>Example: <code>"kvm"</code></p>
<p><strong>Default:</strong> <em>machine-specific</em></p>
</li>
<li>
<p><span id="store-experimental-local-overlay-store-trusted"><a href="#store-experimental-local-overlay-store-trusted"><code>trusted</code></a></span></p>
<p>Whether paths from this store can be used as substitutes
even if they are not signed by a key listed in the
<a href="../../command-ref/conf-file.html#conf-trusted-public-keys"><code>trusted-public-keys</code></a>
setting.</p>
<p><strong>Default:</strong> <code>false</code></p>
</li>
<li>
<p><span id="store-experimental-local-overlay-store-upper-layer"><a href="#store-experimental-local-overlay-store-upper-layer"><code>upper-layer</code></a></span></p>
<p>Directory containing the OverlayFS upper layer for this store's store dir.</p>
<p><strong>Default:</strong> <em>empty</em></p>
</li>
<li>
<p><span id="store-experimental-local-overlay-store-want-mass-query"><a href="#store-experimental-local-overlay-store-want-mass-query"><code>want-mass-query</code></a></span></p>
<p>Whether this store can be queried efficiently for path validity when used as a <a href="../../command-ref/conf-file.html#conf-substituters">substituter</a>.</p>
<p><strong>Default:</strong> <code>false</code></p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../store/types/dummy-store.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../store/types/experimental-ssh-store.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../store/types/dummy-store.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../store/types/experimental-ssh-store.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../redirects.js"></script>


    </div>
    </body>
</html>
