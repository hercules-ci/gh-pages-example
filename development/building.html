<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Building - Nix Reference Manual</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../custom.css">


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Nix Reference Manual</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/NixOS/nix" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/NixOS/nix/tree/master/doc/manual/src/development/building.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="building-nix"><a class="header" href="#building-nix">Building Nix</a></h1>
<p>This section provides some notes on how to start hacking on Nix.
To get the latest version of Nix from GitHub:</p>
<pre><code class="language-console">$ git clone https://github.com/NixOS/nix.git
$ cd nix
</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>The following instructions assume you already have some version of Nix installed locally, so that you can use it to set up the development environment.
If you don't have it installed, follow the <a href="../installation/index.html">installation instructions</a>.</p>
</blockquote>
<p>To build all dependencies and start a shell in which all environment variables are set up so that those dependencies can be found:</p>
<pre><code class="language-console">$ nix-shell
</code></pre>
<p>To get a shell with one of the other <a href="#compilation-environments">supported compilation environments</a>:</p>
<pre><code class="language-console">$ nix-shell --attr devShells.x86_64-linux.native-clangStdenvPackages
</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>You can use <code>native-ccacheStdenvPackages</code> to drastically improve rebuild time.
By default, <a href="https://ccache.dev">ccache</a> keeps artifacts in <code>~/.cache/ccache/</code>.</p>
</blockquote>
<p>To build Nix itself in this shell:</p>
<pre><code class="language-console">[nix-shell]$ autoreconfPhase
[nix-shell]$ ./configure $configureFlags --prefix=$(pwd)/outputs/out
[nix-shell]$ make -j $NIX_BUILD_CORES
</code></pre>
<p>To install it in <code>$(pwd)/outputs</code> and test it:</p>
<pre><code class="language-console">[nix-shell]$ make install
[nix-shell]$ make installcheck -j $NIX_BUILD_CORES
[nix-shell]$ ./outputs/out/bin/nix --version
nix (Nix) 2.12
</code></pre>
<p>To build a release version of Nix for the current operating system and CPU architecture:</p>
<pre><code class="language-console">$ nix-build
</code></pre>
<p>You can also build Nix for one of the <a href="#platforms">supported platforms</a>.</p>
<h2 id="building-nix-with-flakes"><a class="header" href="#building-nix-with-flakes">Building Nix with flakes</a></h2>
<p>This section assumes you are using Nix with the <a href="../development/experimental-features.html#xp-feature-flakes"><code>flakes</code></a> and <a href="../development/experimental-features.html#xp-nix-command"><code>nix-command</code></a> experimental features enabled.</p>
<p>To build all dependencies and start a shell in which all environment variables are set up so that those dependencies can be found:</p>
<pre><code class="language-console">$ nix develop
</code></pre>
<p>This shell also adds <code>./outputs/bin/nix</code> to your <code>$PATH</code> so you can run <code>nix</code> immediately after building it.</p>
<p>To get a shell with one of the other <a href="#compilation-environments">supported compilation environments</a>:</p>
<pre><code class="language-console">$ nix develop .#native-clangStdenvPackages
</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>Use <code>ccacheStdenv</code> to drastically improve rebuild time.
By default, <a href="https://ccache.dev">ccache</a> keeps artifacts in <code>~/.cache/ccache/</code>.</p>
</blockquote>
<p>To build Nix itself in this shell:</p>
<pre><code class="language-console">[nix-shell]$ autoreconfPhase
[nix-shell]$ configurePhase
[nix-shell]$ make -j $NIX_BUILD_CORES OPTIMIZE=0
</code></pre>
<p>To install it in <code>$(pwd)/outputs</code> and test it:</p>
<pre><code class="language-console">[nix-shell]$ make install OPTIMIZE=0
[nix-shell]$ make installcheck check -j $NIX_BUILD_CORES
[nix-shell]$ nix --version
nix (Nix) 2.12
</code></pre>
<p>For more information on running and filtering tests, see
<a href="./testing.html"><code>testing.md</code></a>.</p>
<p>To build a release version of Nix for the current operating system and CPU architecture:</p>
<pre><code class="language-console">$ nix build
</code></pre>
<p>You can also build Nix for one of the <a href="#platforms">supported platforms</a>.</p>
<h2 id="makefile-variables"><a class="header" href="#makefile-variables">Makefile variables</a></h2>
<p>You may need <code>profiledir=$out/etc/profile.d</code> and <code>sysconfdir=$out/etc</code> to run <code>make install</code>.</p>
<p>Run <code>make</code> with <a href="https://www.gnu.org/software/make/manual/make.html#index-_002de"><code>-e</code> / <code>--environment-overrides</code></a> to allow environment variables to override <code>Makefile</code> variables:</p>
<ul>
<li>
<p><code>ENABLE_BUILD=yes</code> to enable building the C++ code.</p>
</li>
<li>
<p><code>ENABLE_DOC_GEN=yes</code> to enable building the documentation (manual, man pages, etc.).</p>
<p>The docs can take a while to build, so you may want to disable this for local development.</p>
</li>
<li>
<p><code>ENABLE_FUNCTIONAL_TESTS=yes</code> to enable building the functional tests.</p>
</li>
<li>
<p><code>OPTIMIZE=1</code> to enable optimizations.</p>
</li>
<li>
<p><code>libraries=libutil programs=</code> to only build a specific library.</p>
<p>This will fail in the linking phase if the other libraries haven't been built, but is useful for checking types.</p>
</li>
<li>
<p><code>libraries= programs=nix</code> to only build a specific program.</p>
<p>This will not work in general, because the programs need the libraries.</p>
</li>
</ul>
<h2 id="platforms"><a class="header" href="#platforms">Platforms</a></h2>
<p>Nix can be built for various platforms, as specified in <a href="https://github.com/nixos/nix/blob/master/flake.nix"><code>flake.nix</code></a>:</p>
<ul>
<li><code>x86_64-linux</code></li>
<li><code>x86_64-darwin</code></li>
<li><code>i686-linux</code></li>
<li><code>aarch64-linux</code></li>
<li><code>aarch64-darwin</code></li>
<li><code>armv6l-linux</code></li>
<li><code>armv7l-linux</code></li>
<li><code>riscv64-linux</code></li>
</ul>
<p>In order to build Nix for a different platform than the one you're currently
on, you need a way for your current Nix installation to build code for that
platform. Common solutions include [remote build machines] and <a href="https://nixos.org/manual/nixos/stable/options.html#opt-boot.binfmt.emulatedSystems">binary format emulation</a>
(only supported on NixOS).</p>
<p>Given such a setup, executing the build only requires selecting the respective attribute.
For example, to compile for <code>aarch64-linux</code>:</p>
<pre><code class="language-console">$ nix-build --attr packages.aarch64-linux.default
</code></pre>
<p>or for Nix with the <a href="../development/experimental-features.html#xp-feature-flakes"><code>flakes</code></a> and <a href="../development/experimental-features.html#xp-nix-command"><code>nix-command</code></a> experimental features enabled:</p>
<pre><code class="language-console">$ nix build .#packages.aarch64-linux.default
</code></pre>
<p>Cross-compiled builds are available for:</p>
<ul>
<li><code>armv6l-linux</code></li>
<li><code>armv7l-linux</code></li>
<li><code>riscv64-linux</code>
Add more <a href="#system-type">system types</a> to <code>crossSystems</code> in <code>flake.nix</code> to bootstrap Nix on unsupported platforms.</li>
</ul>
<h3 id="building-for-multiple-platforms-at-once"><a class="header" href="#building-for-multiple-platforms-at-once">Building for multiple platforms at once</a></h3>
<p>It is useful to perform multiple cross and native builds on the same source tree,
for example to ensure that better support for one platform doesn't break the build for another.
In order to facilitate this, Nix has some support for being built out of tree â€“ that is, placing build artefacts in a different directory than the source code:</p>
<ol>
<li>
<p>Create a directory for the build, e.g.</p>
<pre><code class="language-bash">mkdir build
</code></pre>
</li>
<li>
<p>Run the configure script from that directory, e.g.</p>
<pre><code class="language-bash">cd build
../configure &lt;configure flags&gt;
</code></pre>
</li>
<li>
<p>Run make from the source directory, but with the build directory specified, e.g.</p>
<pre><code class="language-bash">make builddir=build &lt;make flags&gt;
</code></pre>
</li>
</ol>
<h2 id="system-type"><a class="header" href="#system-type">System type</a></h2>
<p>Nix uses a string with the following format to identify the <em>system type</em> or <em>platform</em> it runs on:</p>
<pre><code>&lt;cpu&gt;-&lt;os&gt;[-&lt;abi&gt;]
</code></pre>
<p>It is set when Nix is compiled for the given system, and based on the output of <a href="https://github.com/nixos/nix/blob/master/config/config.guess"><code>config.guess</code></a> (<a href="https://git.savannah.gnu.org/cgit/config.git/tree/config.guess">upstream</a>):</p>
<pre><code>&lt;cpu&gt;-&lt;vendor&gt;-&lt;os&gt;[&lt;version&gt;][-&lt;abi&gt;]
</code></pre>
<p>When Nix is built such that <code>./configure</code> is passed any of the <code>--host</code>, <code>--build</code>, <code>--target</code> options, the value is based on the output of <a href="https://github.com/nixos/nix/blob/master/config/config.sub"><code>config.sub</code></a> (<a href="https://git.savannah.gnu.org/cgit/config.git/tree/config.sub">upstream</a>):</p>
<pre><code>&lt;cpu&gt;-&lt;vendor&gt;[-&lt;kernel&gt;]-&lt;os&gt;
</code></pre>
<p>For historic reasons and backward-compatibility, some CPU and OS identifiers are translated from the GNU Autotools naming convention in <a href="https://github.com/nixos/nix/blob/master/configure.ac"><code>configure.ac</code></a> as follows:</p>
<div class="table-wrapper"><table><thead><tr><th><code>config.guess</code></th><th>Nix</th></tr></thead><tbody>
<tr><td><code>amd64</code></td><td><code>x86_64</code></td></tr>
<tr><td><code>i*86</code></td><td><code>i686</code></td></tr>
<tr><td><code>arm6</code></td><td><code>arm6l</code></td></tr>
<tr><td><code>arm7</code></td><td><code>arm7l</code></td></tr>
<tr><td><code>linux-gnu*</code></td><td><code>linux</code></td></tr>
<tr><td><code>linux-musl*</code></td><td><code>linux</code></td></tr>
</tbody></table>
</div>
<h2 id="compilation-environments"><a class="header" href="#compilation-environments">Compilation environments</a></h2>
<p>Nix can be compiled using multiple environments:</p>
<ul>
<li><code>stdenv</code>: default;</li>
<li><code>gccStdenv</code>: force the use of <code>gcc</code> compiler;</li>
<li><code>clangStdenv</code>: force the use of <code>clang</code> compiler;</li>
<li><code>ccacheStdenv</code>: enable [ccache], a compiler cache to speed up compilation.</li>
</ul>
<p>To build with one of those environments, you can use</p>
<pre><code class="language-console">$ nix build .#nix-ccacheStdenv
</code></pre>
<p>for flake-enabled Nix, or</p>
<pre><code class="language-console">$ nix-build --attr nix-ccacheStdenv
</code></pre>
<p>for classic Nix.</p>
<p>You can use any of the other supported environments in place of <code>nix-ccacheStdenv</code>.</p>
<h2 id="editor-integration"><a class="header" href="#editor-integration">Editor integration</a></h2>
<p>The <code>clangd</code> LSP server is installed by default on the <code>clang</code>-based <code>devShell</code>s.
See <a href="#compilation-environments">supported compilation environments</a> and instructions how to set up a shell <a href="#nix-with-flakes">with flakes</a> or in <a href="#classic-nix">classic Nix</a>.</p>
<p>To use the LSP with your editor, you first need to <a href="https://clangd.llvm.org/installation#project-setup">set up <code>clangd</code></a> by running:</p>
<pre><code class="language-console">make compile_commands.json
</code></pre>
<p>Configure your editor to use the <code>clangd</code> from the <code>.#native-clangStdenvPackages</code> shell. You can do that either by running it inside the development shell, or by using <a href="https://github.com/nix-community/nix-direnv">nix-direnv</a> and <a href="https://github.com/direnv/direnv/wiki#editor-integration">the appropriate editor plugin</a>.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>For some editors (e.g. Visual Studio Code), you may need to install a <a href="https://open-vsx.org/extension/llvm-vs-code-extensions/vscode-clangd">special extension</a> for the editor to interact with <code>clangd</code>.
Some other editors (e.g. Emacs, Vim) need a plugin to support LSP servers in general (e.g. <a href="https://github.com/emacs-lsp/lsp-mode">lsp-mode</a> for Emacs and <a href="https://github.com/prabirshrestha/vim-lsp">vim-lsp</a> for vim).
Editor-specific setup is typically opinionated, so we will not cover it here in more detail.</p>
</blockquote>
<h2 id="formatting-and-pre-commit-hooks"><a class="header" href="#formatting-and-pre-commit-hooks">Formatting and pre-commit hooks</a></h2>
<p>You may run the formatters as a one-off using:</p>
<pre><code class="language-console">make format
</code></pre>
<p>If you'd like to run the formatters before every commit, install the hooks:</p>
<pre><code>pre-commit-hooks-install
</code></pre>
<p>This installs <a href="https://pre-commit.com">pre-commit</a> using <a href="https://github.com/cachix/git-hooks.nix">cachix/git-hooks.nix</a>.</p>
<p>When making a commit, pay attention to the console output.
If it fails, run <code>git add --patch</code> to approve the suggestions <em>and commit again</em>.</p>
<p>To refresh pre-commit hook's config file, do the following:</p>
<ol>
<li>Exit the development shell and start it again by running <code>nix develop</code>.</li>
<li>If you also use the pre-commit hook, also run <code>pre-commit-hooks-install</code> again.</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../development/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../development/testing.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../development/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../development/testing.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../redirects.js"></script>


    </div>
    </body>
</html>
