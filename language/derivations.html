<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Derivations - Nix Reference Manual</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../custom.css">


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Nix Reference Manual</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/NixOS/nix" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/NixOS/nix/tree/master/doc/manual/src/language/derivations.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="derivations"><a class="header" href="#derivations">Derivations</a></h1>
<p>The most important built-in function is <code>derivation</code>, which is used to describe a single derivation:
a specification for running an executable on precisely defined input files to repeatably produce output files at uniquely determined file system paths.</p>
<p>It takes as input an attribute set, the attributes of which specify the inputs to the process.
It outputs an attribute set, and produces a <a href="../glossary.html#gloss-store-derivation">store derivation</a> as a side effect of evaluation.</p>
<h2 id="input-attributes"><a class="header" href="#input-attributes">Input attributes</a></h2>
<h3 id="required"><a class="header" href="#required">Required</a></h3>
<ul>
<li>
<p><a href="#attr-name" id="attr-name"><code>name</code></a> (<a href="../language/types.html#type-string">String</a>)</p>
<p>A symbolic name for the derivation.
It is added to the <a href="../store/store-path.html">store path</a> of the corresponding <a href="../glossary.html#gloss-store-derivation">store derivation</a> as well as to its <a href="../glossary.html#gloss-output-path">output paths</a>.</p>
<blockquote>
<p><strong>Example</strong></p>
<pre><code class="language-nix">derivation {
  name = "hello";
  # ...
}
</code></pre>
<p>The store derivation's path will be <code>/nix/store/&lt;hash&gt;-hello.drv</code>.
The <a href="#attr-outputs">output</a> paths will be of the form <code>/nix/store/&lt;hash&gt;-hello[-&lt;output&gt;]</code></p>
</blockquote>
</li>
<li>
<p><a href="#attr-system" id="attr-system"><code>system</code></a> (<a href="../language/types.html#type-string">String</a>)</p>
<p>The system type on which the <a href="#attr-builder"><code>builder</code></a> executable is meant to be run.</p>
<p>A necessary condition for Nix to build derivations locally is that the <code>system</code> attribute matches the current <a href="../command-ref/conf-file.html#conf-system"><code>system</code> configuration option</a>.
It can automatically <a href="../language/derivations.html#attr-builder">build on other platforms</a> by forwarding build requests to other machines.</p>
<blockquote>
<p><strong>Example</strong></p>
<p>Declare a derivation to be built on a specific system type:</p>
<pre><code class="language-nix">derivation {
  # ...
  system = "x86_64-linux";
  # ...
}
</code></pre>
</blockquote>
<blockquote>
<p><strong>Example</strong></p>
<p>Declare a derivation to be built on the system type that evaluates the expression:</p>
<pre><code class="language-nix">derivation {
  # ...
  system = builtins.currentSystem;
  # ...
}
</code></pre>
<p><a href="../language/builtins.html#builtins-currentSystem"><code>builtins.currentSystem</code></a> has the value of the <a href="../command-ref/conf-file.html#conf-system"><code>system</code> configuration option</a>, and defaults to the system type of the current Nix installation.</p>
</blockquote>
</li>
<li>
<p><a href="#attr-builder" id="attr-builder"><code>builder</code></a> (<a href="../language/types.html#type-path">Path</a> | <a href="../language/types.html#type-string">String</a>)</p>
<p>Path to an executable that will perform the build.</p>
<blockquote>
<p><strong>Example</strong></p>
<p>Use the file located at <code>/bin/bash</code> as the builder executable:</p>
<pre><code class="language-nix">derivation {
  # ...
  builder = "/bin/bash";
  # ...
};
</code></pre>
</blockquote>
<!-- -->
<blockquote>
<p><strong>Example</strong></p>
<p>Copy a local file to the Nix store for use as the builder executable:</p>
<pre><code class="language-nix">derivation {
  # ...
  builder = ./builder.sh;
  # ...
};
</code></pre>
</blockquote>
<!-- -->
<blockquote>
<p><strong>Example</strong></p>
<p>Use a file from another derivation as the builder executable:</p>
<pre><code class="language-nix">let pkgs = import &lt;nixpkgs&gt; {}; in
derivation {
  # ...
  builder = "${pkgs.python}/bin/python";
  # ...
};
</code></pre>
</blockquote>
</li>
</ul>
<h3 id="optional"><a class="header" href="#optional">Optional</a></h3>
<ul>
<li>
<p><a href="#attr-args" id="attr-args"><code>args</code></a> (<a href="../language/types.html#type-list">List</a> of <a href="../language/types.html#type-string">String</a>)</p>
<p>Default: <code>[ ]</code></p>
<p>Command-line arguments to be passed to the <a href="#attr-builder"><code>builder</code></a> executable.</p>
<blockquote>
<p><strong>Example</strong></p>
<p>Pass arguments to Bash to interpret a shell command:</p>
<pre><code class="language-nix">derivation {
  # ...
  builder = "/bin/bash";
  args = [ "-c" "echo hello world &gt; $out" ];
  # ...
};
</code></pre>
</blockquote>
</li>
<li>
<p><a href="#attr-outputs" id="attr-outputs"><code>outputs</code></a> (<a href="../language/types.html#type-list">List</a> of <a href="../language/types.html#type-string">String</a>)</p>
<p>Default: <code>[ "out" ]</code></p>
<p>Symbolic outputs of the derivation.
Each output name is passed to the <a href="#attr-builder"><code>builder</code></a> executable as an environment variable with its value set to the corresponding <a href="../store/store-path.html">store path</a>.</p>
<p>By default, a derivation produces a single output called <code>out</code>.
However, derivations can produce multiple outputs.
This allows the associated <a href="../store/store-object.html">store objects</a> and their <a href="../glossary.html#gloss-closure">closures</a> to be copied or garbage-collected separately.</p>
<blockquote>
<p><strong>Example</strong></p>
<p>Imagine a library package that provides a dynamic library, header files, and documentation.
A program that links against such a library doesn’t need the header files and documentation at runtime, and it doesn’t need the documentation at build time.
Thus, the library package could specify:</p>
<pre><code class="language-nix">derivation {
  # ...
  outputs = [ "lib" "dev" "doc" ];
  # ...
}
</code></pre>
<p>This will cause Nix to pass environment variables <code>lib</code>, <code>dev</code>, and <code>doc</code> to the builder containing the intended store paths of each output.
The builder would typically do something like</p>
<pre><code class="language-bash">./configure \
  --libdir=$lib/lib \
  --includedir=$dev/include \
  --docdir=$doc/share/doc
</code></pre>
<p>for an Autoconf-style package.</p>
</blockquote>
<p>The name of an output is combined with the name of the derivation to create the name part of the output's store path, unless it is <code>out</code>, in which case just the name of the derivation is used.</p>
<blockquote>
<p><strong>Example</strong></p>
<pre><code class="language-nix">derivation {
  name = "example";
  outputs = [ "lib" "dev" "doc" "out" ];
  # ...
}
</code></pre>
<p>The store derivation path will be <code>/nix/store/&lt;hash&gt;-example.drv</code>.
The output paths will be</p>
<ul>
<li><code>/nix/store/&lt;hash&gt;-example-lib</code></li>
<li><code>/nix/store/&lt;hash&gt;-example-dev</code></li>
<li><code>/nix/store/&lt;hash&gt;-example-doc</code></li>
<li><code>/nix/store/&lt;hash&gt;-example</code></li>
</ul>
</blockquote>
<p>You can refer to each output of a derivation by selecting it as an attribute.
The first element of <code>outputs</code> determines the <em>default output</em> and ends up at the top-level.</p>
<blockquote>
<p><strong>Example</strong></p>
<p>Select an output by attribute name:</p>
<pre><code class="language-nix">let
  myPackage = derivation {
    name = "example";
    outputs = [ "lib" "dev" "doc" "out" ];
    # ...
  };
in myPackage.dev
</code></pre>
<p>Since <code>lib</code> is the first output, <code>myPackage</code> is equivalent to <code>myPackage.lib</code>.</p>
</blockquote>
<!-- FIXME: refer to the output attributes when we have one -->
</li>
<li>
<p>See <a href="./advanced-attributes.html">Advanced Attributes</a> for more, infrequently used, optional attributes.</p>
<!-- FIXME: This should be moved here -->
</li>
<li>
<p>Every other attribute is passed as an environment variable to the builder.
Attribute values are translated to environment variables as follows:</p>
<ul>
<li>
<p>Strings are passed unchanged.</p>
</li>
<li>
<p>Integral numbers are converted to decimal notation.</p>
</li>
<li>
<p>Floating point numbers are converted to simple decimal or scientific notation with a preset precision.</p>
</li>
<li>
<p>A <em>path</em> (e.g., <code>../foo/sources.tar</code>) causes the referenced file
to be copied to the store; its location in the store is put in
the environment variable. The idea is that all sources should
reside in the Nix store, since all inputs to a derivation should
reside in the Nix store.</p>
</li>
<li>
<p>A <em>derivation</em> causes that derivation to be built prior to the
present derivation. The environment variable is set to the <a href="../store/store-path.html">store path</a> of the derivation's default <a href="#attr-outputs">output</a>.</p>
</li>
<li>
<p>Lists of the previous types are also allowed. They are simply
concatenated, separated by spaces.</p>
</li>
<li>
<p><code>true</code> is passed as the string <code>1</code>, <code>false</code> and <code>null</code> are
passed as an empty string.</p>
</li>
</ul>
</li>
</ul>
<!-- FIXME: add a section on output attributes -->
<h2 id="builder-execution"><a class="header" href="#builder-execution">Builder execution</a></h2>
<p>The <a href="#attr-builder"><code>builder</code></a> is executed as follows:</p>
<ul>
<li>
<p>A temporary directory is created under the directory specified by
<code>TMPDIR</code> (default <code>/tmp</code>) where the build will take place. The
current directory is changed to this directory.</p>
</li>
<li>
<p>The environment is cleared and set to the derivation attributes, as
specified above.</p>
</li>
<li>
<p>In addition, the following variables are set:</p>
<ul>
<li>
<p><code>NIX_BUILD_TOP</code> contains the path of the temporary directory for
this build.</p>
</li>
<li>
<p>Also, <code>TMPDIR</code>, <code>TEMPDIR</code>, <code>TMP</code>, <code>TEMP</code> are set to point to the
temporary directory. This is to prevent the builder from
accidentally writing temporary files anywhere else. Doing so
might cause interference by other processes.</p>
</li>
<li>
<p><code>PATH</code> is set to <code>/path-not-set</code> to prevent shells from
initialising it to their built-in default value.</p>
</li>
<li>
<p><code>HOME</code> is set to <code>/homeless-shelter</code> to prevent programs from
using <code>/etc/passwd</code> or the like to find the user's home
directory, which could cause impurity. Usually, when <code>HOME</code> is
set, it is used as the location of the home directory, even if
it points to a non-existent path.</p>
</li>
<li>
<p><code>NIX_STORE</code> is set to the path of the top-level Nix store
directory (typically, <code>/nix/store</code>).</p>
</li>
<li>
<p><code>NIX_ATTRS_JSON_FILE</code> &amp; <code>NIX_ATTRS_SH_FILE</code> if <code>__structuredAttrs</code>
is set to <code>true</code> for the derivation. A detailed explanation of this
behavior can be found in the
<a href="./advanced-attributes.html#adv-attr-structuredAttrs">section about structured attrs</a>.</p>
</li>
<li>
<p>For each output declared in <code>outputs</code>, the corresponding
environment variable is set to point to the intended path in the
Nix store for that output. Each output path is a concatenation
of the cryptographic hash of all build inputs, the <code>name</code>
attribute and the output name. (The output name is omitted if
it’s <code>out</code>.)</p>
</li>
</ul>
</li>
<li>
<p>If an output path already exists, it is removed. Also, locks are
acquired to prevent multiple Nix instances from performing the same
build at the same time.</p>
</li>
<li>
<p>A log of the combined standard output and error is written to
<code>/nix/var/log/nix</code>.</p>
</li>
<li>
<p>The builder is executed with the arguments specified by the
attribute <code>args</code>. If it exits with exit code 0, it is considered to
have succeeded.</p>
</li>
<li>
<p>The temporary directory is removed (unless the <code>-K</code> option was
specified).</p>
</li>
<li>
<p>If the build was successful, Nix scans each output path for
references to input paths by looking for the hash parts of the input
paths. Since these are potential runtime dependencies, Nix registers
them as dependencies of the output paths.</p>
</li>
<li>
<p>After the build, Nix sets the last-modified timestamp on all files
in the build result to 1 (00:00:01 1/1/1970 UTC), sets the group to
the default group, and sets the mode of the file to 0444 or 0555
(i.e., read-only, with execute permission enabled if the file was
originally executable). Note that possible <code>setuid</code> and <code>setgid</code>
bits are cleared. Setuid and setgid programs are not currently
supported by Nix. This is because the Nix archives used in
deployment have no concept of ownership information, and because it
makes the build result dependent on the user performing the build.</p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../language/builtins.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../language/advanced-attributes.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../language/builtins.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../language/advanced-attributes.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../redirects.js"></script>


    </div>
    </body>
</html>
