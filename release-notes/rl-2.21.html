<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Release 2.21 (2024-03-11) - Nix 2.28.4 Reference Manual</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../custom.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Nix 2.28.4 Reference Manual</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/NixOS/nix" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/NixOS/nix/tree/master/doc/manual/source/release-notes/rl-2.21.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="release-2210-2024-03-11"><a class="header" href="#release-2210-2024-03-11">Release 2.21.0 (2024-03-11)</a></h1>
<ul>
<li>
<p>Fix a fixed-output derivation sandbox escape (CVE-2024-27297)</p>
<p>Cooperating Nix derivations could send file descriptors to files in the Nix
store to each other via Unix domain sockets in the abstract namespace. This
allowed one derivation to modify the output of the other derivation, after Nix
has registered the path as "valid" and immutable in the Nix database.
In particular, this allowed the output of fixed-output derivations to be
modified from their expected content.</p>
<p>This isn't the case any more.</p>
</li>
<li>
<p>CLI options <code>--arg-from-file</code> and <code>--arg-from-stdin</code> <a href="https://github.com/NixOS/nix/pull/10122">#10122</a></p>
<p>The new CLI option <code>--arg-from-file</code> <em>name</em> <em>path</em> passes the contents
of file <em>path</em> as a string value via the function argument <em>name</em> to a
Nix expression. Similarly, the new option <code>--arg-from-stdin</code> <em>name</em>
reads the contents of the string from standard input.</p>
</li>
<li>
<p>Concise error printing in <code>nix repl</code> <a href="https://github.com/NixOS/nix/pull/9928">#9928</a></p>
<p>Previously, if an element of a list or attribute set threw an error while
evaluating, <code>nix repl</code> would print the entire error (including source location
information) inline. This output was clumsy and difficult to parse:</p>
<pre><code>nix-repl&gt; { err = builtins.throw "uh oh!"; }
{ err = «error:
       … while calling the 'throw' builtin
         at «string»:1:9:
            1| { err = builtins.throw "uh oh!"; }
             |         ^

       error: uh oh!»; }
</code></pre>
<p>Now, only the error message is displayed, making the output much more readable.</p>
<pre><code>nix-repl&gt; { err = builtins.throw "uh oh!"; }
{ err = «error: uh oh!»; }
</code></pre>
<p>However, if the whole expression being evaluated throws an error, source
locations and (if applicable) a stack trace are printed, just like you'd expect:</p>
<pre><code>nix-repl&gt; builtins.throw "uh oh!"
error:
       … while calling the 'throw' builtin
         at «string»:1:1:
            1| builtins.throw "uh oh!"
             | ^

       error: uh oh!
</code></pre>
</li>
<li>
<p><code>--debugger</code> can now access bindings from <code>let</code> expressions <a href="https://github.com/NixOS/nix/issues/8827">#8827</a> <a href="https://github.com/NixOS/nix/pull/9918">#9918</a></p>
<p>Breakpoints and errors in the bindings of a <code>let</code> expression can now access
those bindings in the debugger. Previously, only the body of <code>let</code> expressions
could access those bindings.</p>
</li>
<li>
<p>Enter the <code>--debugger</code> when <code>builtins.trace</code> is called if <code>debugger-on-trace</code> is set <a href="https://github.com/NixOS/nix/pull/9914">#9914</a></p>
<p>If the <code>debugger-on-trace</code> option is set and <code>--debugger</code> is given,
<code>builtins.trace</code> calls will behave similarly to <code>builtins.break</code> and will enter
the debug REPL. This is useful for determining where warnings are being emitted
from.</p>
</li>
<li>
<p>Debugger prints source position information <a href="https://github.com/NixOS/nix/pull/9913">#9913</a></p>
<p>The <code>--debugger</code> now prints source location information, instead of the
pointers of source location information. Before:</p>
<pre><code>nix-repl&gt; :bt
0: while evaluating the attribute 'python311.pythonForBuild.pkgs'
0x600001522598
</code></pre>
<p>After:</p>
<pre><code>0: while evaluating the attribute 'python311.pythonForBuild.pkgs'
/nix/store/hg65h51xnp74ikahns9hyf3py5mlbbqq-source/overrides/default.nix:132:27

   131|
   132|       bootstrappingBase = pkgs.${self.python.pythonAttr}.pythonForBuild.pkgs;
      |                           ^
   133|     in
</code></pre>
</li>
<li>
<p>The <code>--debugger</code> will start more reliably in <code>let</code> expressions and function calls <a href="https://github.com/NixOS/nix/issues/6649">#6649</a> <a href="https://github.com/NixOS/nix/pull/9917">#9917</a></p>
<p>Previously, if you attempted to evaluate this file with the debugger:</p>
<pre><code class="language-nix">let
  a = builtins.trace "before inner break" (
    builtins.break "hello"
  );
  b = builtins.trace "before outer break" (
    builtins.break a
  );
in
  b
</code></pre>
<p>Nix would correctly enter the debugger at <code>builtins.break a</code>, but if you asked
it to <code>:continue</code>, it would skip over the <code>builtins.break "hello"</code> expression
entirely.</p>
<p>Now, Nix will correctly enter the debugger at both breakpoints.</p>
</li>
<li>
<p>Nested debuggers are no longer supported <a href="https://github.com/NixOS/nix/pull/9920">#9920</a></p>
<p>Previously, evaluating an expression that throws an error in the debugger would
enter a second, nested debugger:</p>
<pre><code>nix-repl&gt; builtins.throw "what"
error: what


Starting REPL to allow you to inspect the current state of the evaluator.

Welcome to Nix 2.18.1. Type :? for help.

nix-repl&gt;
</code></pre>
<p>Now, it just prints the error message like <code>nix repl</code>:</p>
<pre><code>nix-repl&gt; builtins.throw "what"
error:
       … while calling the 'throw' builtin
         at «string»:1:1:
            1| builtins.throw "what"
             | ^

       error: what
</code></pre>
</li>
<li>
<p>Consistent order of function arguments in printed expressions <a href="https://github.com/NixOS/nix/pull/9874">#9874</a></p>
<p>Function arguments are now printed in lexicographic order rather than the internal, creation-time based symbol order.</p>
</li>
<li>
<p>Fix duplicate attribute error positions for <code>inherit</code> <a href="https://github.com/NixOS/nix/pull/9874">#9874</a></p>
<p>When an <code>inherit</code> caused a duplicate attribute error the position of the error was not reported correctly, placing the error with the inherit itself or at the start of the bindings block instead of the offending attribute name.</p>
</li>
<li>
<p><code>inherit (x) ...</code> evaluates <code>x</code> only once <a href="https://github.com/NixOS/nix/pull/9847">#9847</a></p>
<p><code>inherit (x) a b ...</code> now evaluates the expression <code>x</code> only once for all inherited attributes rather than once for each inherited attribute.
This does not usually have a measurable impact, but side-effects (such as <code>builtins.trace</code>) would be duplicated and expensive expressions (such as derivations) could cause a measurable slowdown.</p>
</li>
<li>
<p>Store paths are allowed to start with <code>.</code> <a href="https://github.com/NixOS/nix/issues/912">#912</a> <a href="https://github.com/NixOS/nix/pull/9091">#9091</a> <a href="https://github.com/NixOS/nix/pull/9095">#9095</a> <a href="https://github.com/NixOS/nix/pull/9120">#9120</a> <a href="https://github.com/NixOS/nix/pull/9121">#9121</a> <a href="https://github.com/NixOS/nix/pull/9122">#9122</a> <a href="https://github.com/NixOS/nix/pull/9130">#9130</a> <a href="https://github.com/NixOS/nix/pull/9219">#9219</a> <a href="https://github.com/NixOS/nix/pull/9224">#9224</a> <a href="https://github.com/NixOS/nix/pull/9867">#9867</a></p>
<p>Leading periods were allowed by accident in Nix 2.4. The Nix team has considered this to be a bug, but this behavior has since been relied on by users, leading to unnecessary difficulties.
From now on, leading periods are supported. The names <code>.</code> and <code>..</code> are disallowed, as well as those starting with <code>.-</code> or <code>..-</code>.</p>
<p>Nix versions that denied leading periods are documented <a href="https://github.com/NixOS/nix/issues/912#issuecomment-1919583286">in the issue</a>.</p>
</li>
<li>
<p><code>nix repl</code> pretty-prints values <a href="https://github.com/NixOS/nix/pull/9931">#9931</a></p>
<p><code>nix repl</code> will now pretty-print values:</p>
<pre><code>{
  attrs = {
    a = {
      b = {
        c = { };
      };
    };
  };
  list = [ 1 ];
  list' = [
    1
    2
    3
  ];
}
</code></pre>
</li>
<li>
<p>Introduction of <code>--regex</code> and <code>--all</code> in <code>nix profile remove</code> and <code>nix profile upgrade</code> <a href="https://github.com/NixOS/nix/pull/10166">#10166</a></p>
<p>Previously the command-line arguments for <code>nix profile remove</code> and <code>nix profile upgrade</code> matched the package entries using regular expression.
For instance:</p>
<pre><code>nix profile remove '.*vim.*'
</code></pre>
<p>This would remove all packages that contain <code>vim</code> in their name.</p>
<p>In most cases, only singular package names were used to remove and upgrade packages. Mixing this with regular expressions sometimes lead to unintended behavior. For instance, <code>python3.1</code> could match <code>python311</code>.</p>
<p>To avoid unintended behavior, the arguments are now only matching exact names.</p>
<p>Matching using regular expressions is still possible by using the new <code>--regex</code> flag:</p>
<pre><code>nix profile remove --regex '.*vim.*'
</code></pre>
<p>One of the most useful cases for using regular expressions was to upgrade all packages. This was previously accomplished by:</p>
<pre><code>nix profile upgrade '.*'
</code></pre>
<p>With the introduction of the <code>--all</code> flag, this now becomes more straightforward:</p>
<pre><code>nix profile upgrade --all
</code></pre>
</li>
<li>
<p>Visual clutter in <code>--debugger</code> is reduced <a href="https://github.com/NixOS/nix/pull/9919">#9919</a></p>
<p>Before:</p>
<pre><code>info: breakpoint reached


Starting REPL to allow you to inspect the current state of the evaluator.

Welcome to Nix 2.20.0pre20231222_dirty. Type :? for help.

nix-repl&gt; :continue
error: uh oh


Starting REPL to allow you to inspect the current state of the evaluator.

Welcome to Nix 2.20.0pre20231222_dirty. Type :? for help.

nix-repl&gt;
</code></pre>
<p>After:</p>
<pre><code>info: breakpoint reached

Nix 2.20.0pre20231222_dirty debugger
Type :? for help.
nix-repl&gt; :continue
error: uh oh

nix-repl&gt;
</code></pre>
</li>
<li>
<p>Cycle detection in <code>nix repl</code> is simpler and more reliable <a href="https://github.com/NixOS/nix/issues/8672">#8672</a> <a href="https://github.com/NixOS/nix/pull/9926">#9926</a></p>
<p>The cycle detection in <code>nix repl</code>, <code>nix eval</code>, <code>builtins.trace</code>, and everywhere
else values are printed is now simpler and matches the cycle detection in
<code>nix-instantiate --eval</code> output.</p>
<p>Before:</p>
<pre><code>nix eval --expr 'let self = { inherit self; }; in self'
{ self = { self = «repeated»; }; }
</code></pre>
<p>After:</p>
<pre><code>{ self = «repeated»; }
</code></pre>
</li>
<li>
<p>In the debugger, <code>while evaluating the attribute</code> errors now include position information <a href="https://github.com/NixOS/nix/pull/9915">#9915</a></p>
<p>Before:</p>
<pre><code>0: while evaluating the attribute 'python311.pythonForBuild.pkgs'
0x600001522598
</code></pre>
<p>After:</p>
<pre><code>0: while evaluating the attribute 'python311.pythonForBuild.pkgs'
/nix/store/hg65h51xnp74ikahns9hyf3py5mlbbqq-source/overrides/default.nix:132:27

   131|
   132|       bootstrappingBase = pkgs.${self.python.pythonAttr}.pythonForBuild.pkgs;
      |                           ^
   133|     in
</code></pre>
</li>
<li>
<p>Stack size is increased on macOS <a href="https://github.com/NixOS/nix/pull/9860">#9860</a></p>
<p>Previously, Nix would set the stack size to 64MiB on Linux, but would leave the
stack size set to the default (approximately 8KiB) on macOS. Now, the stack
size is correctly set to 64MiB on macOS as well, which should reduce stack
overflow segfaults in deeply-recursive Nix expressions.</p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../release-notes/rl-2.22.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../release-notes/rl-2.20.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../release-notes/rl-2.22.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../release-notes/rl-2.20.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../redirects.js"></script>


    </div>
    </body>
</html>
